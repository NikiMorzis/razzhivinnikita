<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мои Задачи</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Общие стили с поддержкой темной темы */
        :root {
            /* Светлая тема по умолчанию */
            --primary-hue: 230; /* Blue-Violet */
            --primary-color: hsl(var(--primary-hue), 70%, 55%); /* Muted Purple-Blue */
            --primary-color-dark: hsl(var(--primary-hue), 70%, 45%);
            --secondary-color: hsl(260, 60%, 65%); /* Lighter Violet */
            --accent-color: hsl(150, 60%, 50%); /* Green for success */
            --bg-body: linear-gradient(135deg, hsl(210, 30%, 96%) 0%, hsl(210, 30%, 99%) 100%); /* Soft light gradient */
            --bg-card: #ffffff;
            --bg-admin-panel: hsl(210, 20%, 97%);
            --text-heading: hsl(210, 10%, 20%);
            --text-body: hsl(210, 5%, 35%);
            --text-light: hsl(210, 5%, 60%);
            --border-color: hsl(210, 10%, 90%);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 15px 30px rgba(0, 0, 0, 0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --transition-speed: 0.3s;
            --progress-bar-height: 6px;
            --tooltip-bg: hsl(210, 10%, 20%);
            --tooltip-text: #ffffff;
        }
        [data-theme="dark"] {
            --primary-color: hsl(var(--primary-hue), 70%, 60%);
            --primary-color-dark: hsl(var(--primary-hue), 70%, 50%);
            --bg-body: linear-gradient(135deg, hsl(210, 15%, 10%) 0%, hsl(210, 15%, 15%) 100%);
            --bg-card: hsl(210, 10%, 20%);
            --bg-admin-panel: hsl(210, 10%, 25%);
            --text-heading: hsl(210, 5%, 95%);
            --text-body: hsl(210, 5%, 85%);
            --text-light: hsl(210, 5%, 65%);
            --border-color: hsl(210, 10%, 30%);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 15px 30px rgba(0, 0, 0, 0.4);
            --tooltip-bg: hsl(210, 10%, 80%);
            --tooltip-text: hsl(210, 10%, 20%);
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            color: var(--text-body);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background var(--transition-speed) ease;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background-color: var(--bg-card);
            padding: 40px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            position: relative;
            transition: all var(--transition-speed) ease;
        }
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
        }
        h1 {
            color: var(--text-heading);
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 3em;
            letter-spacing: -0.03em;
            position: relative;
            display: inline-block;
        }
        h1::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: var(--primary-color);
            border-radius: 2px;
        }
        p.subtitle {
            color: var(--text-light);
            font-size: 1.1em;
            margin-top: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            font-weight: 500;
        }
        #profile-name { 
            font-weight: 600; 
            color: var(--primary-color-dark);
            background-color: hsla(var(--primary-hue), 70%, 55%, 0.1);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            position: relative;
            transition: all var(--transition-speed) ease;
        }
        #profile-name:hover {
            background-color: hsla(var(--primary-hue), 70%, 55%, 0.2);
            transform: translateY(-1px);
        }
        h2 {
            text-align: center;
            color: var(--text-heading);
            margin-top: 50px;
            margin-bottom: 30px;
            font-weight: 600;
            font-size: 2.2em;
            letter-spacing: -0.02em;
            position: relative;
        }
        h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 1.5px;
        }
        /* Панель кнопок */
        .admin-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }
        .admin-controls button {
            padding: 12px 18px;
            background-color: var(--bg-card);
            color: var(--text-body);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        .admin-controls button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
        }
        .admin-controls button:hover {
            background-color: hsl(210, 20%, 98%);
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--shadow-md);
            color: var(--primary-color-dark);
        }
        .admin-controls button:hover::before {
            animation: shine 1.5s;
        }
        .admin-controls button:hover i { color: var(--primary-color); }
        .admin-controls button.theme-toggle {
            border-radius: 50%;
            width: 48px;
            height: 48px;
            padding: 0;
            justify-content: center;
            align-items: center;
        }
        .admin-controls button.theme-toggle i {
            margin: 0;
            font-size: 1.2em;
        }
        .admin-controls button.theme-toggle.dark-mode i {
            color: #FFD700;
        }
        /* Админ-панель и формы */
        .admin-panel {
            background-color: var(--bg-admin-panel);
            padding: 30px;
            border-radius: var(--radius-md);
            margin-bottom: 40px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            display: none;
            transition: all var(--transition-speed) ease;
        }
        .admin-panel.visible { 
            display: block;
            animation: fadeIn 0.4s ease;
        }
        .admin-panel h3 { 
            margin-top: 0; 
            font-size: 1.6em; 
            color: var(--primary-color); 
            text-align: center; 
            font-weight: 600; 
            margin-bottom: 25px;
            position: relative;
        }
        .admin-panel h3::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 2px;
            background: var(--primary-color);
            border-radius: 1px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .form-grid.single-col { 
            grid-template-columns: 1fr; 
        }
        .form-grid label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            font-size: 0.9em; 
            color: var(--text-heading);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .form-grid label i {
            color: var(--primary-color);
            font-size: 0.9em;
        }
        .form-grid input, .form-grid select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 1em;
            box-sizing: border-box;
            background-color: var(--bg-card);
            transition: all 0.3s ease;
            color: var(--text-body);
            position: relative;
        }
        .form-grid input::placeholder { 
            color: var(--text-light); 
        }
        .form-grid input:focus, .form-grid select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px hsla(var(--primary-hue), 70%, 55%, 0.2);
            background-color: #fcfdff;
        }
        .form-grid .full-width { 
            grid-column: 1 / -1; 
        }
        .form-grid button {
            background-color: var(--primary-color);
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }
        .form-grid button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.6s;
        }
        .form-grid button:hover::before {
            left: 100%;
        }
        .form-grid button:hover { 
            background-color: var(--primary-color-dark); 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-lg); 
        }
        /* Прогресс-бар для проектов */
        .project-progress {
            width: 100%;
            height: var(--progress-bar-height);
            background-color: hsl(210, 10%, 90%);
            border-radius: var(--progress-bar-height);
            margin: 12px 0 15px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-color-dark));
            border-radius: var(--progress-bar-height);
            width: 0%;
            transition: width 0.5s ease;
        }
        /* Стили для карточек */
        .project-list {
            display: grid;
            gap: 25px;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }
        .project-card {
            background-color: var(--bg-card);
            padding: 25px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            border-left: 6px solid transparent;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.4s forwards;
        }
        .project-card:nth-child(1) { animation-delay: 0.05s; }
        .project-card:nth-child(2) { animation-delay: 0.1s; }
        .project-card:nth-child(3) { animation-delay: 0.15s; }
        .project-card:nth-child(4) { animation-delay: 0.2s; }
        .project-card:hover { 
            transform: translateY(-5px); 
            box-shadow: var(--shadow-lg); 
        }
        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent 70%, rgba(0,0,0,0.02) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .project-card:hover::before { 
            opacity: 1; 
        }
        /* Статусы карточек */
        .project-card.status-в-работе { border-left-color: hsl(200, 70%, 50%); } /* Blue */
        .project-card.status-на-проверке { border-left-color: hsl(40, 90%, 60%); } /* Orange */
        .project-card.status-на-паузе { border-left-color: hsl(0, 70%, 60%); }    /* Red */
        .project-card.status-завершено { border-left-color: var(--accent-color); } /* Green */
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 18px; 
            gap: 15px;
        }
        .card-header h3 { 
            margin: 0; 
            font-size: 1.4em; 
            font-weight: 600; 
            color: var(--text-heading);
            line-height: 1.3;
            position: relative;
            transition: all 0.2s ease;
        }
        .card-header h3:hover {
            color: var(--primary-color);
        }
        .status-badge { 
            padding: 6px 12px; 
            border-radius: var(--radius-sm); 
            color: white; 
            font-weight: 600; 
            font-size: 0.75em; 
            text-transform: uppercase; 
            white-space: nowrap;
            letter-spacing: 0.05em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .status-badge.status-в-работе { background-color: hsl(200, 70%, 55%); }
        .status-badge.status-завершено { background-color: var(--accent-color); }
        .status-badge.status-на-паузе { background-color: hsl(0, 70%, 65%); }
        .status-badge.status-на-проверке { background-color: hsl(40, 90%, 65%); }
        .card-body { 
            flex-grow: 1; 
            margin-bottom: 15px; 
        }
        .card-body p { 
            margin: 10px 0; 
            font-size: 0.9em; 
            word-break: break-word; 
            display: flex; 
            align-items: center; 
        }
        .card-body strong { 
            color: var(--text-heading); 
            font-weight: 600; 
            margin-right: 5px;
        }
        .card-body p i { 
            margin-right: 12px; 
            color: var(--primary-color); 
            width: 18px; 
            text-align: center; 
            font-size: 1.1em; 
        }
        .card-body p a { 
            color: var(--primary-color); 
            text-decoration: none; 
            font-weight: 500; 
            transition: color 0.2s ease;
            position: relative;
            padding-bottom: 2px;
        }
        .card-body p a:hover { 
            color: var(--primary-color-dark); 
            text-decoration: underline; 
        }
        .card-body p a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 1px;
            background: var(--primary-color-dark);
            transition: width 0.3s ease;
        }
        .card-body p a:hover::after {
            width: 100%;
        }
        .card-footer { 
            margin-top: auto; 
            padding-top: 20px; 
            border-top: 1px dashed var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 15px;
        }
        .card-footer .priority {
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 0.85em;
            font-weight: 600;
            background-color: hsl(var(--primary-hue), 10%, 95%);
            color: var(--text-heading);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        .card-footer .priority:hover {
            background-color: hsl(var(--primary-hue), 15%, 90%);
            transform: scale(1.05);
        }
        .action-buttons { 
            display: flex; 
            gap: 8px; 
            position: relative;
        }
        .action-buttons button { 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-size: 1.1em; 
            transition: all 0.2s ease; 
            padding: 8px; 
            border-radius: var(--radius-sm); 
            display: none; 
            color: var(--text-light);
            position: relative;
            overflow: hidden;
        }
        .action-buttons button.visible { 
            display: block; 
        }
        .action-buttons button:hover { 
            background-color: hsl(210, 10%, 95%); 
            transform: translateY(-2px);
        }
        .complete-btn { 
            color: var(--accent-color); 
            position: relative;
        } 
        .complete-btn:hover { 
            color: white; 
            background-color: var(--accent-color); 
        }
        .edit-btn { 
            color: hsl(210, 70%, 55%); 
        } 
        .edit-btn:hover { 
            color: white; 
            background-color: hsl(210, 70%, 55%); 
        }
        .delete-btn { 
            color: hsl(0, 70%, 60%); 
        } 
        .delete-btn:hover { 
            color: white; 
            background-color: hsl(0, 70%, 60%); 
        }
        /* Подсказки (tooltips) */
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tooltip-bg);
            color: var(--tooltip-text);
            padding: 5px 10px;
            border-radius: var(--radius-sm);
            font-size: 0.8em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-bottom: 5px;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid var(--tooltip-bg);
        }
        .action-buttons button:hover .tooltip {
            opacity: 1;
        }
        /* Фильтры и прочее */
        .show-completed-btn {
            background-color: var(--bg-admin-panel);
            color: var(--primary-color-dark);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            margin-top: 20px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .show-completed-btn:hover {
            background-color: hsl(210, 20%, 95%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .filter-controls { 
            text-align: center; 
            margin-bottom: 30px; 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            flex-wrap: wrap; 
            padding: 20px;
            background-color: var(--bg-admin-panel);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        .filter-controls label { 
            font-weight: 600; 
            color: var(--text-heading); 
            margin-right: 5px; 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .filter-controls select { 
            padding: 10px 15px; 
            border: 1px solid var(--border-color); 
            border-radius: var(--radius-sm); 
            font-size: 0.95em; 
            background-color: var(--bg-card); 
            box-shadow: var(--shadow-sm); 
            min-width: 120px;
            color: var(--text-body);
            transition: all 0.2s ease;
        }
        .filter-controls select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px hsla(var(--primary-hue), 70%, 55%, 0.2);
        }
        .completed-projects-container.hidden, #app-container.hidden { 
            display: none; 
        }
        /* Модальное окно для создания профиля и редактирования */
        .modal-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0, 0, 0, 0.6); 
            backdrop-filter: blur(8px);
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible { 
            display: flex; 
            opacity: 1; 
        }
        .modal-content {
            background: var(--bg-card); 
            padding: 40px; 
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg); 
            width: 90%; 
            max-width: 800px;
            transform: translateY(-20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            border: 1px solid var(--border-color);
        }
        .modal-overlay.visible .modal-content { 
            transform: translateY(0); 
            opacity: 1; 
        }
        .modal-content h2 { 
            margin-top: 0; 
            margin-bottom: 25px; 
            color: var(--text-heading); 
            font-size: 2em; 
            text-align: center; 
        }
        .modal-content p { 
            text-align: center; 
            margin-bottom: 25px; 
            color: var(--text-light); 
        }
        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes shine {
            to {
                transform: translateX(100%);
            }
        }
        /* Адаптивность */
        @media (max-width: 768px) {
            body { 
                padding: 15px 10px; 
            }
            .container { 
                padding: 25px 15px; 
                border-radius: var(--radius-md); 
            }
            h1 { 
                font-size: 2.2em; 
            }
            h2 { 
                font-size: 1.8em; 
                margin-top: 40px; 
            }
            .project-list { 
                grid-template-columns: 1fr; 
            }
            .admin-controls { 
                flex-direction: row; 
                bottom: 15px; 
                right: 15px; 
                left: 15px; 
                justify-content: center; 
                gap: 8px;
            }
            .admin-controls button { 
                padding: 10px 12px; 
                font-size: 0.9em; 
                flex: 1;
                justify-content: center;
            }
            .admin-controls button span { 
                display: none; 
            } /* Скрыть текст на мобильных */
            .form-grid { 
                grid-template-columns: 1fr; 
                gap: 15px; 
            }
            .modal-content { 
                padding: 25px; 
                width: 95%; 
                border-radius: var(--radius-md); 
            }
            .filter-controls { 
                flex-direction: column; 
                gap: 10px; 
                padding: 15px; 
            }
            .card-header h3 { 
                font-size: 1.2em; 
            }
            .card-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .action-buttons {
                justify-content: flex-end;
                width: 100%;
            }
        }
        /* Стили для пустых состояний */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            border-radius: var(--radius-md);
            background-color: var(--bg-admin-panel);
            border: 1px dashed var(--border-color);
            margin: 20px 0;
        }
        .empty-state i {
            font-size: 3em;
            color: var(--text-light);
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .empty-state h3 {
            color: var(--text-heading);
            margin-bottom: 10px;
            font-size: 1.4em;
        }
        .empty-state p {
            color: var(--text-light);
            max-width: 400px;
            margin: 0 auto 20px;
        }
    </style>
</head>
<body>
    <div id="profile-setup-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Настройте ваш профиль</h2>
            <p>Добро пожаловать! Введите ваши данные, чтобы начать управлять задачами.</p>
            <form id="profile-setup-form" class="form-grid single-col">
                <div><label for="user-fullname"><i class="fas fa-user"></i> Ваше ФИО</label><input type="text" id="user-fullname" placeholder="Например, Иванов Иван Иванович" required></div>
                <div><label for="user-id"><i class="fas fa-id-card"></i> Уникальный ID профиля</label><input type="text" id="user-id" placeholder="Например, ivanov-dev-profile (используется для сохранения)" required></div>
                <button type="submit" class="full-width">Сохранить и начать работу</button>
            </form>
        </div>
    </div>
    <div id="edit-task-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="edit-modal-title">Редактирование задачи</h2>
             <form id="edit-task-form" class="form-grid">
                <input type="hidden" id="edit-projectId">
                <input type="hidden" id="edit-projectType">
                <div><label for="edit-projectName"><i class="fas fa-project-diagram"></i> Название проекта</label><input type="text" id="edit-projectName" required></div>
                <div><label for="edit-orderId"><i class="fas fa-barcode"></i> ID заказа</label><input type="text" id="edit-orderId" required></div>
                <div><label for="edit-clientName"><i class="fas fa-user-tie"></i> Клиент</label><input type="text" id="edit-clientName" required></div>
                <div><label for="edit-status"><i class="fas fa-flag"></i> Статус</label>
                    <select id="edit-status" required>
                        <option value="В работе">В работе</option>
                        <option value="На проверке">На проверке</option>
                        <option value="На паузе">На паузе</option>
                        <option value="Завершено">Завершено</option>
                    </select>
                </div>
                <div><label for="edit-priority"><i class="fas fa-star"></i> Приоритет</label><select id="edit-priority" required><option value="Высокий">Высокий</option><option value="Средний">Средний</option><option value="Низкий">Низкий</option></select></div>
                <div><label for="edit-deadline"><i class="fas fa-calendar-alt"></i> Дедлайн</label><input type="date" id="edit-deadline"></div>
                <div><label for="edit-cost"><i class="fas fa-money-bill-wave"></i> Стоимость (₽)</label><input type="text" id="edit-cost" required></div>
                <div><label for="edit-commission"><i class="fas fa-percentage"></i> Процент вознаграждения (%)</label><input type="number" id="edit-commission" min="0" max="100" step="0.1" placeholder="33" required></div>
                <div><label for="edit-projectLink"><i class="fas fa-link"></i> Ссылка</label><input type="text" id="edit-projectLink"></div>
                <button type="submit" class="full-width">Сохранить изменения</button>
                <button type="button" id="close-edit-modal-btn" class="full-width" style="background-color: hsl(210, 10%, 70%);">Отмена</button>
            </form>
        </div>
    </div>
    <div id="app-container" class="hidden">
        <div class="container">
            <header>
                <h1>Мои задачи</h1>
                <p class="subtitle">
                    Профиль: <span id="profile-name"></span>
                </p>
                <button id="show-completed-btn" class="show-completed-btn">
                    <i class="fas fa-tasks"></i> Показать выполненные проекты
                </button>
            </header>
            <div class="admin-controls">
                <!-- Кнопка ВСЕГДА видна -->
                <button id="show-admin-btn" title="Панель администратора"><i class="fas fa-tools"></i> <span>Панель</span></button>
                <button id="download-btn" title="Скачать профиль"><i class="fas fa-download"></i> <span>Скачать</span></button>
                <button id="upload-btn" title="Загрузить профиль"><i class="fas fa-upload"></i> <span>Загрузить</span></button>
                <button class="theme-toggle" id="theme-toggle" title="Переключить тему"><i class="fas fa-moon"></i></button>
            </div>
            <input type="file" id="file-input" style="display: none;" accept=".json">
            <div id="admin-panel" class="admin-panel">
                <h3>Администрирование</h3>
                <form id="edit-profile-form" class="form-grid single-col" style="margin-bottom: 25px; border-bottom: 1px dashed var(--border-color); padding-bottom: 25px;">
                     <div><label for="admin-edit-fullname"><i class="fas fa-user-edit"></i> Изменить ФИО в профиле</label><input type="text" id="admin-edit-fullname"></div>
                     <button type="submit">Обновить ФИО</button>
                </form>
                <h3>Добавить новую задачу</h3>
                <form id="add-project-form" class="form-grid">
                    <div><label for="projectName"><i class="fas fa-project-diagram"></i> Название проекта</label><input type="text" id="projectName" required></div>
                    <div><label for="orderId"><i class="fas fa-barcode"></i> ID заказа</label><input type="text" id="orderId" placeholder="Например, A12345" required></div>
                    <div><label for="clientName"><i class="fas fa-user-tie"></i> Клиент</label><input type="text" id="clientName" required></div>
                    <div><label for="status"><i class="fas fa-flag"></i> Статус</label><select id="status" required><option value="В работе">В работе</option><option value="На проверке">На проверке</option><option value="На паузе">На паузе</option></select></div>
                    <div><label for="priority"><i class="fas fa-star"></i> Приоритет</label><select id="priority" required><option value="Высокий">Высокий</option><option value="Средний">Средний</option><option value="Низкий">Низкий</option></select></div>
                    <div><label for="deadline"><i class="fas fa-calendar-alt"></i> Дедлайн</label><input type="date" id="deadline" required></div>
                    <div><label for="cost"><i class="fas fa-money-bill-wave"></i> Стоимость (₽)</label><input type="text" id="cost" placeholder="150000" required></div>
                    <div><label for="commission"><i class="fas fa-percentage"></i> Процент вознаграждения (%)</label><input type="number" id="commission" min="0" max="100" step="0.1" placeholder="33" value="33" required></div>
                    <div><label for="projectLink"><i class="fas fa-link"></i> Ссылка</label><input type="text" id="projectLink" placeholder="URL-адрес"></div>
                    <button type="submit" class="full-width">Добавить задачу</button>
                </form>
            </div>
            <h2>Текущие задачи</h2>
            <div id="current-project-list" class="project-list"></div>
            <div id="no-current-tasks" class="empty-state" style="display: none;">
                <i class="fas fa-clipboard-list"></i>
                <h3>Нет текущих задач</h3>
                <p>Задачи будут отображаться здесь после их добавления администратором.</p>
                <!-- КНОПКИ "Создать задачу" НЕТ -->
            </div>
            <div id="completed-projects-container" class="completed-projects-container hidden">
                <h2 class="completed-heading">Выполненные проекты</h2>
                <div class="filter-controls">
                    <div>
                        <label for="month-filter"><i class="fas fa-calendar"></i> Месяц:</label>
                        <select id="month-filter">
                            <option value="">Все</option>
                            <option value="0">Январь</option><option value="1">Февраль</option><option value="2">Март</option><option value="3">Апрель</option><option value="4">Май</option><option value="5">Июнь</option><option value="6">Июль</option><option value="7">Август</option><option value="8">Сентябрь</option><option value="9">Октябрь</option><option value="10">Ноябрь</option><option value="11">Декабрь</option>
                        </select>
                    </div>
                    <div>
                        <label for="year-filter"><i class="fas fa-calendar-alt"></i> Год:</label>
                        <select id="year-filter"></select>
                    </div>
                </div>
                <div id="completed-project-list" class="project-list"></div>
                <div id="no-completed-tasks" class="empty-state" style="display: none;">
                    <i class="fas fa-check-circle"></i>
                    <h3>Нет выполненных задач</h3>
                    <p>После завершения задач они появятся здесь</p>
                </div>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Элементы DOM
        const appContainer = document.getElementById('app-container');
        const profileSetupModal = document.getElementById('profile-setup-modal');
        const profileSetupForm = document.getElementById('profile-setup-form');
        const profileNameElement = document.getElementById('profile-name');
        const currentProjectListElement = document.getElementById('current-project-list');
        const completedProjectListElement = document.getElementById('completed-project-list');
        const addProjectForm = document.getElementById('add-project-form');
        const adminPanel = document.getElementById('admin-panel');
        const showAdminBtn = document.getElementById('show-admin-btn');
        const editProfileForm = document.getElementById('edit-profile-form');
        const showCompletedBtn = document.getElementById('show-completed-btn');
        const completedProjectsContainer = document.getElementById('completed-projects-container');
        const monthFilter = document.getElementById('month-filter');
        const yearFilter = document.getElementById('year-filter');
        const downloadBtn = document.getElementById('download-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const fileInput = document.getElementById('file-input');
        const editTaskModal = document.getElementById('edit-task-modal');
        const editTaskForm = document.getElementById('edit-task-form');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const noCurrentTasksMessage = document.getElementById('no-current-tasks');
        const noCompletedTasksMessage = document.getElementById('no-completed-tasks');
        const themeToggle = document.getElementById('theme-toggle');

        // Глобальные переменные состояния
        let state = {
            userInfo: null,
            currentProjects: [],
            completedProjects: [],
            isAdminLoggedIn: false,
            theme: 'light' // 'light' или 'dark'
        };

        // --- ФУНКЦИИ УПРАВЛЕНИЯ ДАННЫМИ ---
        function loadState() {
            const savedState = localStorage.getItem('taskProfile');
            if (savedState) {
                state = JSON.parse(savedState);
                return true;
            }
            return false;
        }
        function saveState() {
            localStorage.setItem('taskProfile', JSON.stringify(state));
        }

        // --- УПРАВЛЕНИЕ ТЕМАМИ ---
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            state.theme = theme;
            saveState();
            // Обновить иконку
            const themeIcon = themeToggle.querySelector('i');
            if (theme === 'dark') {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                themeToggle.classList.add('dark-mode');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                themeToggle.classList.remove('dark-mode');
            }
        }
        function initTheme() {
            // Проверяем сохраненную тему
            if (state.theme) {
                setTheme(state.theme);
                return;
            }
            // Проверяем системные настройки
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            setTheme(prefersDark ? 'dark' : 'light');
        }

        // --- РЕНДЕРИНГ И ОБНОВЛЕНИЕ UI ---
        function renderAll() {
            if (state.userInfo) {
                profileNameElement.textContent = state.userInfo.fullName;
                document.title = `Мои Задачи — ${state.userInfo.fullName}`;
                document.getElementById('admin-edit-fullname').value = state.userInfo.fullName;
                profileSetupModal.classList.remove('visible');
                appContainer.classList.remove('hidden');
                renderCurrentProjects();
                renderCompletedProjects();
                populateYearFilter();
            } else {
                profileSetupModal.classList.add('visible');
                appContainer.classList.add('hidden');
            }
            // Обновить видимость кнопок редактирования/удаления в карточках
            document.querySelectorAll('.edit-btn').forEach(btn => btn.classList.toggle('visible', state.isAdminLoggedIn));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.classList.toggle('visible', state.isAdminLoggedIn));
            // Кнопка "Панель" ВСЕГДА видна — не скрываем её
        }

        const toLocalISODate = (dateString) => {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return ''; // Проверка на некорректную дату
                const offset = date.getTimezoneOffset();
                const adjustedDate = new Date(date.getTime() - (offset * 60 * 1000));
                return adjustedDate.toISOString().split('T')[0];
            } catch (e) {
                console.error("Error parsing date:", dateString, e);
                return '';
            }
        }

        // Форматирование валюты
        const formatCurrency = (value) => {
            const numericValue = parseFloat(String(value).replace(/[^\d.,]/g, '').replace(',', '.'));
            return isNaN(numericValue) ? '0 ₽' : numericValue.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 0 });
        };

        const getStatusClass = (status) => 'status-' + status.toLowerCase().replace(/ /g, '-');

        function calculateProgress(project) {
            if (!project.deadline) return 0;
            const today = new Date();
            const deadline = new Date(project.deadline);
            const startDate = new Date(project.creationDate || today);
            // Если проект уже просрочен
            if (today > deadline) return 100;
            const totalDays = (deadline - startDate) / (1000 * 60 * 60 * 24);
            const elapsedDays = (today - startDate) / (1000 * 60 * 60 * 24);
            // Ограничиваем от 0 до 100
            return Math.min(100, Math.max(0, Math.round((elapsedDays / totalDays) * 100)));
        }

        function createProjectCard(project, type) {
            const isCurrent = type === 'current';
            const statusClass = getStatusClass(project.status);
            const card = document.createElement('div');
            card.className = `project-card ${statusClass}`;
            card.dataset.id = project.id;
            // Добавляем дату создания для расчета прогресса
            if (isCurrent && !project.creationDate) {
                project.creationDate = new Date().toISOString();
            }
            // Рассчитываем прогресс
            const progress = isCurrent ? calculateProgress(project) : 100;
            const deadlineHTML = project.deadline ? `<p><i class="fas fa-calendar-alt"></i><strong>Дедлайн:</strong> ${toLocalISODate(project.deadline)}</p>` : '';
            const completionDateHTML = project.completionDate ? `<p><i class="fas fa-calendar-check"></i><strong>Выполнено:</strong> ${new Date(project.completionDate).toLocaleDateString('ru-RU')}</p>` : '';
            const incomeHTML = project.income !== undefined ? `<p><i class="fas fa-hand-holding-dollar"></i><strong>Доход:</strong> ${formatCurrency(project.income)}</p>` : '';
            const priorityHTML = isCurrent && project.priority ? `<p><strong>Приоритет:</strong> <span class="priority">${project.priority}</span></p>` : '';
            const linkHTML = project.link ? `<p><i class="fas fa-link"></i><strong>Ссылка:</strong> <a href="${project.link}" target="_blank" rel="noopener noreferrer">Перейти</a></p>` : '';
            // Прогресс-бар
            const progressHTML = isCurrent ? `
                <div class="project-progress">
                    <div class="progress-bar" style="width: ${progress}%"></div>
                </div>
            ` : '';

            card.innerHTML = `
                <div class="card-header">
                    <h3>${project.name}</h3>
                    <span class="status-badge ${statusClass}">${project.status}</span>
                </div>
                ${progressHTML}
                <div class="card-body">
                    <p><i class="fas fa-fingerprint"></i><strong>ID заказа:</strong> ${project.orderId}</p>
                    <p><i class="fas fa-user-tie"></i><strong>Клиент:</strong> ${project.client}</p>
                    ${isCurrent ? deadlineHTML : completionDateHTML}
                    <p><i class="fas fa-money-bill-wave"></i><strong>Стоимость:</strong> ${formatCurrency(project.cost)}</p>
                    ${!isCurrent ? incomeHTML : ''}
                    ${linkHTML}
                </div>
                <div class="card-footer">
                    ${priorityHTML}
                    <div class="action-buttons">
                        ${isCurrent ? `<button class="complete-btn visible" title="Завершить"><i class="fas fa-check"></i><span class="tooltip">Завершить задачу</span></button>` : ''}
                        <button class="edit-btn ${state.isAdminLoggedIn ? 'visible' : ''}" title="Редактировать"><i class="fas fa-pencil-alt"></i><span class="tooltip">Редактировать</span></button>
                        <button class="delete-btn ${state.isAdminLoggedIn ? 'visible' : ''}" title="Удалить"><i class="fas fa-trash-alt"></i><span class="tooltip">Удалить</span></button>
                    </div>
                </div>
            `;
            return card;
        }

        function renderCurrentProjects() {
            currentProjectListElement.innerHTML = '';
            if (state.currentProjects.length === 0) {
                noCurrentTasksMessage.style.display = 'block';
            } else {
                noCurrentTasksMessage.style.display = 'none';
                state.currentProjects.forEach(p => currentProjectListElement.appendChild(createProjectCard(p, 'current')));
            }
        }

        function renderCompletedProjects() {
            const selectedMonth = monthFilter.value;
            const selectedYear = yearFilter.value;
            const filteredProjects = state.completedProjects.filter(project => {
                if (!project.completionDate) return false;
                const completionDate = new Date(project.completionDate);
                const projectMonth = completionDate.getMonth().toString();
                const projectYear = completionDate.getFullYear().toString();
                return (selectedMonth === '' || projectMonth === selectedMonth) && (selectedYear === '' || projectYear === selectedYear);
            });
            completedProjectListElement.innerHTML = '';
            if (filteredProjects.length === 0) {
                noCompletedTasksMessage.style.display = 'block';
            } else {
                noCompletedTasksMessage.style.display = 'none';
                filteredProjects.forEach(p => completedProjectListElement.appendChild(createProjectCard(p, 'completed')));
            }
        }

        function populateYearFilter() {
            const years = new Set(state.completedProjects.map(p => new Date(p.completionDate).getFullYear()));
            yearFilter.innerHTML = '<option value="">Все</option>';
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
        }

        // --- ОБРАБОТЧИКИ СОБЫТИЙ ---
        profileSetupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            state.userInfo = {
                fullName: document.getElementById('user-fullname').value,
                profileId: document.getElementById('user-id').value
            };
            saveState();
            renderAll();
        });

        addProjectForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const commission = parseFloat(document.getElementById('commission').value);
            const cost = document.getElementById('cost').value;
            const numericCost = parseFloat(String(cost).replace(/[^\d.,]/g, '').replace(',', '.'));
            const income = isNaN(numericCost) || isNaN(commission) ? 0 : (numericCost * commission / 100);
            const newProject = {
                id: Date.now(),
                orderId: document.getElementById('orderId').value,
                name: document.getElementById('projectName').value,
                client: document.getElementById('clientName').value,
                status: document.getElementById('status').value,
                priority: document.getElementById('priority').value,
                deadline: document.getElementById('deadline').value,
                cost: cost,
                commission: commission,
                link: document.getElementById('projectLink').value,
                creationDate: new Date().toISOString()
            };
            state.currentProjects.push(newProject);
            saveState();
            renderCurrentProjects();
            addProjectForm.reset();
            document.getElementById('commission').value = '33'; // сброс на дефолт
        });

        // УДАЛЕНО: createFirstTaskBtn

        showAdminBtn.addEventListener('click', () => {
            if (state.isAdminLoggedIn) {
                adminPanel.classList.remove('visible');
                state.isAdminLoggedIn = false;
                showAdminBtn.innerHTML = '<i class="fas fa-tools"></i> <span>Панель</span>';
            } else {
                const password = prompt('Введите пароль:');
                if (password === '1111') {
                    adminPanel.classList.add('visible');
                    state.isAdminLoggedIn = true;
                    showAdminBtn.innerHTML = '<i class="fas fa-user-shield"></i> <span>Админ</span>';
                } else {
                    alert('Неверный пароль!');
                }
            }
            renderAll(); // Обновляем UI, чтобы кнопки редактирования появились/исчезли
        });

        editProfileForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newName = document.getElementById('admin-edit-fullname').value;
            if (newName && state.userInfo) {
                state.userInfo.fullName = newName;
                saveState();
                renderAll();
                alert('ФИО успешно обновлено!');
            }
        });

        showCompletedBtn.addEventListener('click', () => {
            completedProjectsContainer.classList.toggle('hidden');
            showCompletedBtn.textContent = completedProjectsContainer.classList.contains('hidden') ? 
                'Показать выполненные проекты' : 'Скрыть выполненные проекты';
            if (!completedProjectsContainer.classList.contains('hidden')) {
                renderCompletedProjects();
            }
        });

        // Делегирование событий для кнопок на карточках
        appContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const card = e.target.closest('.project-card');
            if (!card) return;
            const id = parseInt(card.dataset.id);
            const type = currentProjectListElement.contains(card) ? 'current' : 'completed';
            if (button.classList.contains('delete-btn')) {
                if(confirm('Вы уверены, что хотите удалить эту задачу?')) {
                    if (type === 'current') {
                        state.currentProjects = state.currentProjects.filter(p => p.id !== id);
                    } else {
                        state.completedProjects = state.completedProjects.filter(p => p.id !== id);
                    }
                    saveState();
                    renderAll();
                }
            } else if (button.classList.contains('complete-btn')) {
                const projectIndex = state.currentProjects.findIndex(p => p.id === id);
                if (projectIndex !== -1) {
                    const project = state.currentProjects[projectIndex];
                    const numericCost = parseFloat(String(project.cost).replace(/[^\d.,]/g, '').replace(',', '.'));
                    const commission = project.commission || 33;
                    const income = isNaN(numericCost) ? 0 : (numericCost * commission / 100);
                    const completedProject = { ...project, status: "Завершено", income, completionDate: new Date().toISOString() };
                    delete completedProject.priority;
                    delete completedProject.deadline;
                    state.completedProjects.push(completedProject);
                    state.currentProjects.splice(projectIndex, 1);
                    saveState();
                    renderAll();
                }
            } else if (button.classList.contains('edit-btn')) {
                const projectData = (type === 'current' ? state.currentProjects : state.completedProjects).find(p => p.id === id);
                if (projectData) {
                    // Заполнение формы
                    document.getElementById('edit-projectId').value = projectData.id;
                    document.getElementById('edit-projectType').value = type;
                    document.getElementById('edit-projectName').value = projectData.name;
                    document.getElementById('edit-orderId').value = projectData.orderId;
                    document.getElementById('edit-clientName').value = projectData.client;
                    document.getElementById('edit-status').value = projectData.status;
                    document.getElementById('edit-cost').value = projectData.cost;
                    document.getElementById('edit-commission').value = projectData.commission || 33;
                    document.getElementById('edit-projectLink').value = projectData.link || '';
                    const prioritySelect = document.getElementById('edit-priority');
                    const deadlineInput = document.getElementById('edit-deadline');
                    if (type === 'current') {
                        prioritySelect.value = projectData.priority || 'Средний';
                        deadlineInput.value = toLocalISODate(projectData.deadline);
                        prioritySelect.parentElement.style.display = 'block';
                        deadlineInput.parentElement.style.display = 'block';
                        document.getElementById('edit-commission').parentElement.style.display = 'block';
                    } else {
                        prioritySelect.parentElement.style.display = 'none';
                        deadlineInput.parentElement.style.display = 'none';
                        document.getElementById('edit-commission').parentElement.style.display = 'none';
                    }
                    editTaskModal.classList.add('visible');
                }
            }
        });

        closeEditModalBtn.addEventListener('click', () => editTaskModal.classList.remove('visible'));
        editTaskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('edit-projectId').value);
            const originalType = document.getElementById('edit-projectType').value;
            const newStatus = document.getElementById('edit-status').value;
            let projectToUpdate;
            let projectIndex;
            if (originalType === 'current') {
                projectIndex = state.currentProjects.findIndex(p => p.id === id);
                projectToUpdate = state.currentProjects[projectIndex];
            } else {
                projectIndex = state.completedProjects.findIndex(p => p.id === id);
                projectToUpdate = state.completedProjects[projectIndex];
            }
            if (!projectToUpdate) {
                alert('Ошибка: задача не найдена!');
                return;
            }
            // Обновляем общие данные
            projectToUpdate.name = document.getElementById('edit-projectName').value;
            projectToUpdate.orderId = document.getElementById('edit-orderId').value;
            projectToUpdate.client = document.getElementById('edit-clientName').value;
            projectToUpdate.cost = document.getElementById('edit-cost').value;
            projectToUpdate.commission = parseFloat(document.getElementById('edit-commission').value);
            projectToUpdate.link = document.getElementById('edit-projectLink').value;
            projectToUpdate.status = newStatus;
            // Если задача в "Текущих", обновляем специфичные для нее поля
            if (originalType === 'current') {
                projectToUpdate.priority = document.getElementById('edit-priority').value;
                projectToUpdate.deadline = document.getElementById('edit-deadline').value;
            }
            // Логика перемещения между списками, если статус изменился
            const wasCompleted = originalType === 'completed';
            const isNowCompleted = newStatus === 'Завершено';
            if (!wasCompleted && isNowCompleted) {
                // Перемещаем из текущих в завершенные
                const numericCost = parseFloat(String(projectToUpdate.cost).replace(/[^\d.,]/g, '').replace(',', '.'));
                const commission = projectToUpdate.commission || 33;
                projectToUpdate.income = isNaN(numericCost) ? 0 : (numericCost * commission / 100);
                projectToUpdate.completionDate = new Date().toISOString();
                delete projectToUpdate.priority;
                delete projectToUpdate.deadline;
                state.completedProjects.push(projectToUpdate);
                state.currentProjects.splice(projectIndex, 1); // Удаляем из старого списка
            } else if (wasCompleted && !isNowCompleted) {
                // Перемещаем из завершенных в текущие
                projectToUpdate.priority = 'Средний'; // Значение по умолчанию
                projectToUpdate.deadline = new Date().toISOString().split('T')[0]; // Сегодняшняя дата по умолчанию
                delete projectToUpdate.income;
                delete projectToUpdate.completionDate;
                state.currentProjects.push(projectToUpdate);
                state.completedProjects.splice(projectIndex, 1); // Удаляем из старого списка
            } else {
                 // Если статус не изменился так, что нужно перемещать, просто обновляем текущий массив
                 if (originalType === 'current') {
                     state.currentProjects[projectIndex] = projectToUpdate;
                 } else {
                     state.completedProjects[projectIndex] = projectToUpdate;
                 }
            }
            saveState();
            renderAll();
            editTaskModal.classList.remove('visible');
        });

        monthFilter.addEventListener('change', renderCompletedProjects);
        yearFilter.addEventListener('change', renderCompletedProjects);

        // --- ЗАГРУЗКА И ВЫГРУЗКА ПРОФИЛЯ ---
        downloadBtn.addEventListener('click', () => {
            if (!state.userInfo) {
                alert('Профиль не создан. Нечего скачивать.');
                return;
            }
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.userInfo.profileId || 'tasks-profile'}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        uploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (loadedData.userInfo && loadedData.currentProjects && loadedData.completedProjects) {
                        state = loadedData;
                        saveState();
                        renderAll();
                        alert('Профиль успешно загружен!');
                    } else {
                        alert('Неверный формат файла профиля.');
                    }
                } catch (error) {
                    alert('Ошибка при чтении файла: ' + error.message);
                }
            };
            reader.readAsText(file);
            fileInput.value = '';
        });

        // --- ПЕРЕКЛЮЧЕНИЕ ТЕМ ---
        themeToggle.addEventListener('click', () => {
            const newTheme = state.theme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        });

        // --- ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ СТРАНИЦЫ ---
        if (!loadState()) {
            profileSetupModal.classList.add('visible');
        }
        initTheme();
        renderAll();
    });
    </script>
</body>
</html>
